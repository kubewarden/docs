<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-architecture">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Kubernetes Dynamic Admission at your fingertips</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubewarden.io/architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="description" content="Kubewarden is a Kubernetes policy engine that uses policies written using"><meta data-rh="true" property="og:description" content="Kubewarden is a Kubernetes policy engine that uses policies written using"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubewarden.io/architecture"><link data-rh="true" rel="alternate" href="https://kubewarden.io/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://kubewarden.io/architecture" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5eecb69e.css">
<link rel="preload" href="/assets/js/runtime~main.d0579041.js" as="script">
<link rel="preload" href="/assets/js/main.b5445cef.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__docs navbar__link--active" href="/">Docs</a><a href="https://github.com/kubewarden/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/tasks">Common Tasks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Common Tasks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/writing-policies/">Writing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Writing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rust/intro-rust">Supported Languages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rego/open-policy-agent/intro">Supported Frameworks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/distributing-policies">Distributing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Distributing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/testing-policies/intro">Testing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operator-manual/intro">Operator Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operator Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Architecture</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture</h1><p>Kubewarden is a Kubernetes policy engine that uses policies written using
WebAssembly.</p><p>The Kubewarden stack is made by the following components:</p><ul><li><p>Kubewarden Custom Resources: these are <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreferrer">Kubernetes Custom Resources</a>
that simplify the process of managing policies.</p></li><li><p><a href="https://github.com/kubewarden/kubewarden-controller" target="_blank" rel="noopener noreferrer"><code>kubewarden-controller</code></a>:
this is a Kubernetes controller that reconciles Kubewarden&#x27;s Custom Resources.
This component creates parts of the Kubewarden stack and, most important of
all, translates Kubewarden&#x27;s concepts into native Kubernetes directives.</p></li><li><p>Kubewarden policies: these are WebAssembly modules that hold the validation
or mutation logic. These are covered in depth inside of <a href="/writing-policies/">this chapter</a>.</p></li><li><p><a href="https://github.com/kubewarden/policy-server" target="_blank" rel="noopener noreferrer"><code>policy-server</code></a>:
this component receives the requests to be validated. It does that
by executing Kubewarden&#x27;s policies.</p></li></ul><p>At the bottom of the stack, Kubewarden&#x27;s integrates with Kubernetes using the
concept of <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreferrer">Dynamic Admission Control</a>.
In particular, Kubewarden operates as a Kubernetes Admission Webhook.
<code>policy-server</code> is the actual Webhook endpoint that is reached by Kubernetes
API server to validate relevant requests.</p><p>Kubernetes is made aware of the existence of Kubewarden&#x27;s Webhook endpoints by
<code>kubewarden-controller</code>. This is done by registering either
a <code>MutatingWebhookConfiguration</code> or a <code>ValidatingWebhookConfiguration</code>
object.</p><p>This diagram shows the full architecture overview of a cluster running
the Kubewarden stack:</p><p><img loading="lazy" alt="Full architecture" src="/assets/images/architecture-59488ce36b12f13c779fe02a35bb1ffb.png" width="1387" height="632" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="journey-of-a-kubewarden-policy">Journey of a Kubewarden policy<a class="hash-link" href="#journey-of-a-kubewarden-policy" title="Direct link to heading">‚Äã</a></h2><p>The architecture diagram from above can be intimidating at first, this
section explains it step by step.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="default-policy-server">Default Policy Server<a class="hash-link" href="#default-policy-server" title="Direct link to heading">‚Äã</a></h3><p>On a fresh new cluster, the Kubewarden components defined are its Custom
Resource Definitions, the <code>kubewarden-controller</code> Deployment and a <code>PolicyServer</code>
Custom Resource named <code>default</code>.</p><p><img loading="lazy" alt="Defining the first ClusterAdmissionPolicy resource" src="/assets/images/architecture_sequence_01-4f634ca9150b2d99a07dd0d4a2624b5f.png" width="1123" height="635" class="img_E7b_"></p><p><code>kubewarden-controller</code> notices the default <code>PolicyServer</code> resource and, as a result of that,
it creates a Deployment of the <code>policy-server</code> component.</p><p>As stated above, Kubewarden works as a Kubernetes Admission Webhook. Kubernetes
dictates that all the Webhook endpoints must be secured with TLS.
<code>kubewarden-controller</code> takes care of setting up this secure communication
by doing these steps:</p><ol><li>Generate a self-signed Certificate Authority</li><li>Use this CA to generate a TLS certificate and a TLS key for the
<code>policy-server</code> Service.</li></ol><p>All these objects are stored into Kubernetes as Secret resources.</p><p>Finally, <code>kubewarden-controller</code> will create the <code>policy-server</code>
Deployment and a Kubernetes ClusterIP Service to expose it inside of
the cluster network.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="defining-the-first-policy">Defining the first policy<a class="hash-link" href="#defining-the-first-policy" title="Direct link to heading">‚Äã</a></h3><p>This chart shows what happens when the first policy bounded to the default <code>policy-server</code> is defined inside of the
cluster:</p><p><img loading="lazy" alt="Defining the first ClusterAdmissionPolicy resource" src="/assets/images/architecture_sequence_02-9f94d02c0a9e42b25bccae6aada0a2bd.png" width="1123" height="635" class="img_E7b_"></p><p><code>kubewarden-controller</code> notices the new <code>ClusterAdmissionPolicy</code> resource and,
as a result of that, it finds the bounded <code>PolicyServer</code> and reconciles it.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="reconciliation-of-policy-server">Reconciliation of <code>policy-server</code><a class="hash-link" href="#reconciliation-of-policy-server" title="Direct link to heading">‚Äã</a></h3><p>When a <code>ClusterAdmissionPolicy</code> is created, modified or deleted a reconciliation loop for the <code>PolicyServer</code>
that owns the policy is triggered inside the <code>kubewarden-controller</code>.
In this reconciliation loop, a ConfigMap with all the polices bounded to
the <code>PolicyServer</code> is created. Then the a Deployment rollout of the
interested <code>policy-server</code> is started. As a result of that, the new <code>policy-server</code>
instance will be started with the updated configuration.</p><p>At start time, <code>policy-server</code> reads its configuration and downloads
all the Kubewarden policies. Policies can be downloaded from remote
endpoints like HTTP(s) servers and container registries.</p><p>Policies&#x27; behaviour can be tuned by users via policy-specific configuration
parameters. Once all the policies are downloaded, <code>policy-server</code> will ensure
the policy settings provided by the user are valid.</p><p><code>policy-server</code> performs the validation of policies&#x27;s settings by
invoking the <code>validate_setting</code> function exposed by each policy.
This topic is covered more in depth inside
of <a href="/writing-policies/spec/intro-spec">this section</a> of the documentation.</p><p><code>policy-server</code> will exit with an error if one or more policies received wrong
configuration parameters from the end user.</p><p>If all the policies are properly configured, <code>policy-server</code> will spawn a
pool of worker threads to evaluate incoming requests using the Kubewarden
policies specified by the user.</p><p>Finally, <code>policy-server</code> will start a HTTPS server that listens to incoming
validation requests. The web server is secured using the TLS key and certificate
that have been previously created by <code>kubewarden-controller</code>.</p><p>Each policy is exposed by the web server via a dedicated path that follows this
naming convention: <code>/validate/&lt;policy ID&gt;</code>.</p><p>This is how the cluster looks like once the initialization of <code>policy-server</code>
is completed:</p><p><img loading="lazy" alt="policy-server initialized" src="/assets/images/architecture_sequence_03-b601f6352389dcc81dad199af0e0c87a.png" width="1175" height="641" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="making-kubernetes-aware-of-the-policy">Making Kubernetes aware of the policy<a class="hash-link" href="#making-kubernetes-aware-of-the-policy" title="Direct link to heading">‚Äã</a></h3><p>The <code>policy-server</code> Pods have a
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreferrer"><code>Readiness Probe</code></a>,
<code>kubewarden-controller</code> relies on that to know when the <code>policy-server</code> Deployment
is ready to evaluate admission reviews.</p><p>Once the <code>policy-server</code> Deployment is marked as <code>Ready</code>, <code>kubewarden-controller</code>
will make the Kubernetes API server aware of the new policy by creating either a
<code>MutatingWebhookConfiguration</code> or a <code>ValidatingWebhookConfiguration</code>
object.</p><p>Each policy has its dedicated <code>MutatingWebhookConfiguration</code>/<code>ValidatingWebhookConfiguration</code>
which points to the Webhook endpoint served by <code>policy-server</code>. The endpoint
is reachable by the <code>/validate/&lt;policy ID&gt;</code> URL mentioned before.</p><p><img loading="lazy" alt="Kubernetes Webhook endpoint configuration" src="/assets/images/architecture_sequence_04-615e4e3f91682b0a5a52382f45e5803b.png" width="1181" height="624" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="policy-in-action">Policy in action<a class="hash-link" href="#policy-in-action" title="Direct link to heading">‚Äã</a></h3><p>Now that all the plumbing has been done, Kubernetes will start sending the
relevant Admission Review requests to the right <code>policy-server</code> endpoint.</p><p><img loading="lazy" alt="Policy in action" src="/assets/images/architecture_sequence_05-c8eae1426a3086cdb921feda111ff30d.png" width="1181" height="624" class="img_E7b_"></p><p><code>policy-server</code> receives the Admission Request object and, based on the
endpoint that received the request, uses the right policy to evaluate it.</p><p>Each policy is evaluated inside of its own dedicated WebAssembly sandbox.
The communication between <code>policy-server</code> (the &quot;host&quot;) and the WebAssembly
policy (the &quot;guest&quot;) is done using the waPC communication protocol. This is
covered in depth inside of <a href="/writing-policies/">this</a>
section of the documentation.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-multiple-policy-servers-and-policies-are-handled">How multiple policy servers and policies are handled<a class="hash-link" href="#how-multiple-policy-servers-and-policies-are-handled" title="Direct link to heading">‚Äã</a></h2><p>A cluster can have multiple policy servers and Kubewarden policies defined. </p><p>Benefits of having multiple policy servers:</p><ul><li>Noisy Namespaces/Tenants generating lots of policy evaluations can be isolated from the rest of the cluster and do not affect other users.</li><li>Mission critical policies can be run inside of a Policy Server &quot;pool&quot;, making your whole infrastructure more resilient.</li></ul><p>Each <code>policy-server</code> is defined via its own <code>PolicyServer</code> resource and each policy is defined via its own
<code>ClusterAdmissionPolicy</code> resource. </p><p>This leads back to the initial diagram:</p><p><img loading="lazy" alt="Full architecture" src="/assets/images/architecture-59488ce36b12f13c779fe02a35bb1ffb.png" width="1387" height="632" class="img_E7b_"></p><p>A <code>ClusterAdmissionPolicy</code> is bounded to a <code>PolicyServer</code>. <code>ClusterAdmissionPolicies</code> that don&#x27;t specify any <code>PolicyServer</code>
will be bounded to the <code>PolicyServer</code> named <code>default</code>. If a <code>ClusterAdmissionPolicy</code> references a <code>PolicyServer</code> that doesn&#x27;t
exist, it will be in an <code>unschedulable</code> state.</p><p>Each <code>policy-server</code> defines multiple validation endpoints, one per policy defined
inside of its configuration file. It&#x27;s also possible to load the same policy
multiple times, just with different configuration parameters.</p><p>The Kubernetes API server is made aware of these policy via the
<code>ValidatingWebhookConfiguration</code> and <code>MutatingWebhookConfiguration</code> resources
that are kept in sync by <code>kubewarden-controller</code>.</p><p>Finally, the incoming admission requests are then dispatched by the Kubernetes
API server to the right validation endpoint exposed by <code>policy-server</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kubewarden/docs/edit/main/docs/architecture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-05-06T10:50:43.000Z">5/6/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tasksDir/psp-migration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">PSP Migration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/writing-policies/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Writing Policies</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#journey-of-a-kubewarden-policy" class="table-of-contents__link toc-highlight">Journey of a Kubewarden policy</a><ul><li><a href="#default-policy-server" class="table-of-contents__link toc-highlight">Default Policy Server</a></li><li><a href="#defining-the-first-policy" class="table-of-contents__link toc-highlight">Defining the first policy</a></li><li><a href="#reconciliation-of-policy-server" class="table-of-contents__link toc-highlight">Reconciliation of <code>policy-server</code></a></li><li><a href="#making-kubernetes-aware-of-the-policy" class="table-of-contents__link toc-highlight">Making Kubernetes aware of the policy</a></li><li><a href="#policy-in-action" class="table-of-contents__link toc-highlight">Policy in action</a></li></ul></li><li><a href="#how-multiple-policy-servers-and-policies-are-handled" class="table-of-contents__link toc-highlight">How multiple policy servers and policies are handled</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d0579041.js"></script>
<script src="/assets/js/main.b5445cef.js"></script>
</body>
</html>