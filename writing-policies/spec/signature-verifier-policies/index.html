<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-writing-policies/spec/signature-verifier-policies">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Kubewarden ¬∑ Kubernetes Dynamic Admission at your fingertips</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.kubewarden.io/writing-policies/spec/signature-verifier-policies"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="description" content="Kubewarden implements support for the Sigstore"><meta data-rh="true" property="og:description" content="Kubewarden implements support for the Sigstore"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.kubewarden.io/writing-policies/spec/signature-verifier-policies"><link data-rh="true" rel="alternate" href="https://docs.kubewarden.io/writing-policies/spec/signature-verifier-policies" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.kubewarden.io/writing-policies/spec/signature-verifier-policies" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5eecb69e.css">
<link rel="preload" href="/assets/js/runtime~main.5ad1f88c.js" as="script">
<link rel="preload" href="/assets/js/main.2a78e29d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__docs navbar__link--active" href="/">Docs</a><a href="https://github.com/kubewarden/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/tasks">Common Tasks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Common Tasks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/writing-policies/">Writing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Writing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/writing-policies/spec/intro-spec">Policy Specification</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/writing-policies/spec/intro-spec">Policy Communication Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/writing-policies/spec/settings">Policy Settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/writing-policies/spec/validating-policies">Validating Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/writing-policies/spec/mutating-policies">Mutating Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/writing-policies/spec/context-aware-policies">Context Aware Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/writing-policies/spec/signature-verifier-policies">Signature Verifier Policies</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rust/intro-rust">Supported Languages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rego/open-policy-agent/intro">Supported Frameworks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/distributing-policies">Distributing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Distributing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/testing-policies/intro">Testing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operator-manual/intro">Operator Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operator Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/writing-policies/"><span itemprop="name">Writing Policies</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">Policy Specification</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Signature Verifier Policies</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Signature verifier policies</h1><p>Kubewarden implements support for the <a href="https://www.sigstore.dev/" target="_blank" rel="noopener noreferrer">Sigstore</a>
project. This allows to implement a Secure Supply Chain for your cluster.</p><p>Part of that is to ensure that all container images running in the cluster are
signed and verified, proving that they come from their stated authors, and
haven&#x27;t been tampered with. For further reading, do check out the docs on
<a href="/distributing-policies/secure-supply-chain">how we implement a Secure Supply Chain for the policies themselves</a>).</p><p>Sigstore signatures are stored inside of container registries, next to the OCI
object being signed; be it a container image or a more generic OCI artifact,
like a Kubewarden policy. Given an object to be signed, all its signatures are
going to be stored as layers of a special OCI object created by sigstore.
Policies that want to check Sigstore signatures of containers need then to check
those layers, and would need to pull the signature layers to see the
signatures themselves.</p><p>Obtaining and operating with those OCI layers needs to happen outside of the
WebAssembly guest (the policy). Hence this is done by the WebAssembly runtime:
Kubewarden&#x27;s <code>policy-server</code> or <code>kwctl</code>.</p><p>The different language SDKs for Kubewarden policies take care of all that, and
provide functions for verification of container image, Kubewarden policies, Helm
charts and generally speaking any kind of OCI artifact. This ensures a safe and
tested codepath for verification. In addition, pulling data from a registry and
cryptographically verifying signatures can be time and computationally
expensive, so the WebAssembly runtime (PolicyServer, <code>kwctl</code>) ensures both
signature pulls and verification computations are cached. The cached entries
are automatically expired after 60 seconds to prevent stale data from being
served.</p><p>The SDKs provide functions similar to the following:</p><ul><li><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">verify_pub_keys_image(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image_url: string,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vector_of_pub_keys: vector&lt;string&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vector_of_sigstore_annotations: Vector&lt;(key, value: string)&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    returns (is_trusted: bool, digest_of_verified_image: string)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">verify_keyless_exact_match(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image_url: string,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vector_of_tuples_issuer_and_subject: vector&lt;(issuer, subject: string)&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vector_of_sigstore_annotations: vector&lt;(key, value: string)&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    returns (is_trusted: bool, digest_of_verified_image: string)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><p>Both functions verify that the image is signed and satisfy the passed
constraints.</p><p>Note well: on success, the functions return the digest of the verified image. It
is now on the policy to ensure that containers are instantiated from that
digest, and not from tag that may or may not match that checksum digest (and
therefore be compromised).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="a-concrete-example">A concrete example<a class="hash-link" href="#a-concrete-example" title="Direct link to heading">‚Äã</a></h2><p>The Kubewarden team <a href="https://github.com/kubewarden/verify-image-signatures" target="_blank" rel="noopener noreferrer">provides a verifier policy</a>
that enforces Sigstore signatures for all containers, built on Rust and with the
Rust SDK. The policy ensures that the containers are signed, and optionally,
mutates the requests appending the exact verified checksum to the tag of the
image. Check its docs for specifics.</p><p>This policy may cover all your needs, but in case you would prefer a different
UX, of course you can build on top of it or any of the other SDKs.</p><h1>WaPC protocol contract</h1><p>In case you are implementing your own language SDK, these are the functions a
policy that verifies signatures can use:</p><table><thead><tr><th><strong>waPC function name</strong></th><th><strong>Input payload</strong></th><th><strong>Output payload</strong></th></tr></thead><tbody><tr><td>v1/verify</td><td>{<br>  // <strong>mandatory</strong>:<br>  &quot;image&quot;: string, // image URI to verify<br>  &quot;pub_keys&quot;: <!-- -->[ // PEM-encoded public keys<br>    string<br>  ]<!-- -->,<br>  // optional:<br>  &quot;annotations&quot;: <!-- -->[ // signature annotations<br>    {<br>      &quot;key&quot;: string,<br>      &quot;value&quot;: string<br>    },<br>  ]<br>}</td><td>{<br>  &quot;is_trusted&quot;: boolean, // true if image verified<br>  &quot;digest&quot;: string       // digest of verified image<br>}</td></tr><tr><td>v1/verify</td><td>{<br>  // <strong>mandatory</strong>:<br>  &quot;image&quot;: string, // image URI to verify<br>  &quot;keyless&quot;: <!-- -->[ // list of (issuer, subject) tuples<br>    {<br>      &quot;issuer&quot;: string, // OIDC issuer<br>      &quot;subject&quot;: string // signature subject (mail, CI URL...)<br>    }<br>  ]<!-- -->,<br>  // optional:<br>  &quot;annotations&quot;: <!-- -->[ // signature annotations<br>    {<br>      &quot;key&quot;: string,<br>      &quot;value&quot;: string<br>    },<br>  ]<br>}</td><td>{<br>  &quot;is_trusted&quot;: boolean, // true if image verified<br>  &quot;digest&quot;: string       // digest of verified image<br>}</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kubewarden/docs/edit/main/docs/writing-policies/spec/06-signature-verifier-policies.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-05-06T11:17:32.000Z">5/6/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/writing-policies/spec/context-aware-policies"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Context Aware Policies</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/writing-policies/rust/intro-rust"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction to Rust</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-concrete-example" class="table-of-contents__link toc-highlight">A concrete example</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5ad1f88c.js"></script>
<script src="/assets/js/main.2a78e29d.js"></script>
</body>
</html>